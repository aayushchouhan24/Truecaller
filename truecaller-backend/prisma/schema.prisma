generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ── User ──────────────────────────────────────────────────────────────────

enum VerificationLevel {
  NONE
  OTP_VERIFIED
  ID_VERIFIED
}

model User {
  id                String            @id @default(uuid())
  phoneNumber       String            @unique @map("phone_number")
  name              String?
  verificationLevel VerificationLevel @default(OTP_VERIFIED) @map("verification_level")
  trustScore        Float             @default(1.0) @map("trust_score")
  isSuspicious      Boolean           @default(false) @map("is_suspicious")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  spamReports       SpamReport[]
  contacts          UserContact[]
  nameContributions NameContribution[]
  favorites         Favorite[]

  @@map("users")
}

// ── Number Identity ───────────────────────────────────────────────────────

model NumberIdentity {
  id                String    @id @default(uuid())
  phoneNumber       String    @unique @map("phone_number")
  resolvedName      String?   @map("resolved_name")
  confidence        Float     @default(0) @map("confidence")
  sourceCount       Int       @default(0) @map("source_count")
  verifiedName      String?   @map("verified_name")
  verificationLevel VerificationLevel @default(NONE) @map("verification_level")
  tags              String[]  @default([])
  probableRole      String?   @map("probable_role")
  description       String?
  reasoning         String?
  lastResolvedAt    DateTime? @map("last_resolved_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  contributions NameContribution[]
  clusters      NameCluster[]

  @@index([phoneNumber])
  @@map("number_identities")
}

// ── Name Contributions ────────────────────────────────────────────────────

enum SourceType {
  CONTACT_UPLOAD
  MANUAL
  SELF_DECLARED
}

model NameContribution {
  id                   String     @id @default(uuid())
  identityId           String     @map("identity_id")
  contributorId        String?    @map("contributor_id")
  rawName              String     @map("raw_name")
  cleanedName          String     @map("cleaned_name")
  sourceType           SourceType @default(CONTACT_UPLOAD) @map("source_type")
  contributorTrustWeight Float    @default(1.0) @map("contributor_trust_weight")
  deviceFingerprint    String?    @map("device_fingerprint")
  createdAt            DateTime   @default(now()) @map("created_at")

  identity    NumberIdentity @relation(fields: [identityId], references: [id], onDelete: Cascade)
  contributor User?          @relation(fields: [contributorId], references: [id], onDelete: SetNull)

  @@index([identityId])
  @@index([contributorId])
  @@index([cleanedName])
  @@map("name_contributions")
}

// ── Name Clusters ─────────────────────────────────────────────────────────

model NameCluster {
  id               String   @id @default(uuid())
  identityId       String   @map("identity_id")
  representativeName String @map("representative_name")
  variants         String[] @map("variants")
  totalWeight      Float    @default(0) @map("total_weight")
  frequency        Int      @default(0)
  isSpamTagged     Boolean  @default(false) @map("is_spam_tagged")
  updatedAt        DateTime @updatedAt @map("updated_at")

  identity NumberIdentity @relation(fields: [identityId], references: [id], onDelete: Cascade)

  @@index([identityId])
  @@map("name_clusters")
}

// ── Spam ───────────────────────────────────────────────────────────────────

model SpamReport {
  id          String   @id @default(uuid())
  reporterId  String   @map("reporter_id")
  phoneNumber String   @map("phone_number")
  reason      String?
  createdAt   DateTime @default(now()) @map("created_at")

  reporter User @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([phoneNumber])
  @@map("spam_reports")
}

model SpamScore {
  phoneNumber String   @unique @map("phone_number")
  score       Int      @default(0)
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("spam_scores")
}

// ── User Contacts (for syncing & contributing names) ──────────────────────

model UserContact {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  phoneNumber String   @map("phone_number")
  name        String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, phoneNumber])
  @@index([phoneNumber])
  @@map("user_contacts")
}

// ── Favorites ─────────────────────────────────────────────────────────────

model Favorite {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  phoneNumber String   @map("phone_number")
  name        String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, phoneNumber])
  @@map("favorites")
}

// ── Rate Limiting for Anti-Manipulation ──────────────────────────────────

model ContributionRateLimit {
  id                String   @id @default(uuid())
  deviceFingerprint String?  @map("device_fingerprint")
  userId            String?  @map("user_id")
  contributionCount Int      @default(0) @map("contribution_count")
  windowStart       DateTime @default(now()) @map("window_start")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([deviceFingerprint])
  @@unique([userId])
  @@map("contribution_rate_limits")
}

// ── Token Statistics (data-driven token classification) ─────────────

model TokenStatistic {
  id               String   @id @default(uuid())
  token            String   @unique
  globalFrequency  Int      @default(0) @map("global_frequency")
  numberCount      Int      @default(0) @map("number_count")
  positionFirstPct Float    @default(0) @map("position_first_pct")
  positionLastPct  Float    @default(0) @map("position_last_pct")
  soloFrequency    Int      @default(0) @map("solo_frequency")
  avgTrustWeight   Float    @default(0) @map("avg_trust_weight")
  classifiedAs     String?  @map("classified_as")
  nameScore        Float    @default(0) @map("name_score")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([token])
  @@index([classifiedAs])
  @@map("token_statistics")
}

// ── Name Reference (auto-learning name dictionary) ──────────────────

enum NameCategory {
  FIRST_NAME
  LAST_NAME
  MIDDLE_NAME
  PREFIX
  RELATIONSHIP
  DESCRIPTOR
}

enum NameSource {
  SEED        // Hardcoded seed data
  LEARNED     // Auto-learned from data patterns
  CONFIRMED   // Manually confirmed / verified
}

model NameReference {
  id         String       @id @default(uuid())
  token      String       @unique
  category   NameCategory
  source     NameSource   @default(SEED)
  confidence Float        @default(1.0)
  frequency  Int          @default(0)   // how many times seen in data
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  @@index([category])
  @@index([source])
  @@map("name_references")
}

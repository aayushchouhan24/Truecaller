name: Backend PR Validation

on:
  pull_request:
    branches:
      - deploy
      - main
    paths:
      - 'truecaller-backend/src/**'
      - 'truecaller-backend/prisma/**'
      - 'truecaller-backend/package*.json'
      - 'truecaller-backend/Dockerfile'
      - 'truecaller-backend/tsconfig.json'

env:
  WORKING_DIR: truecaller-backend

jobs:
  validate:
    name: Validate Changes
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Check TypeScript compilation
        run: npm run build

      - name: Run linting
        run: npm run lint || echo "‚ö†Ô∏è Linting issues found (non-blocking)"

      - name: Validate Prisma schema
        run: npx prisma validate

      - name: Check for security vulnerabilities
        run: |
          npm audit --audit-level=high || {
            echo "‚ö†Ô∏è Security vulnerabilities found"
            echo "Please review and update dependencies"
            exit 1
          }

  docker-build-test:
    name: Test Docker Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Backend Docker image (test)
        run: |
          docker build \
            -t truecaller-backend:test \
            -f Dockerfile \
            .
          
          echo "‚úÖ Backend Docker build successful"

      - name: Test Docker image
        run: |
          # Quick smoke test
          docker run --rm truecaller-backend:test node --version
          echo "‚úÖ Docker image verified"

  prisma-migration-check:
    name: Check Prisma Migrations
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check for migration drift
        run: |
          npx prisma migrate status || {
            echo "‚ö†Ô∏è Migration drift detected or pending migrations"
            echo "Please ensure migrations are up to date"
          }

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate, docker-build-test, prisma-migration-check]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "üìä Backend Validation Summary"
          echo "===================="
          echo "Code validation: ${{ needs.validate.result }}"
          echo "Docker build: ${{ needs.docker-build-test.result }}"
          echo "Prisma check: ${{ needs.prisma-migration-check.result }}"
          
          if [ "${{ needs.validate.result }}" != "success" ] || \
             [ "${{ needs.docker-build-test.result }}" != "success" ]; then
            echo ""
            echo "‚ùå Some checks failed. Please review before merging."
            exit 1
          else
            echo ""
            echo "‚úÖ All checks passed! Ready to merge."
          fi
